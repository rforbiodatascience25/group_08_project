---
title: "Group08 - 05_analysis_3"
subtitle: "PCA plot"
author: "Greta"
format: html
editor: visual
---

## Load packages

```{r}
library("tidyverse")
library("broom")

```

## Load data

```{r}
clean_data <- read_tsv("../_raw/data/03_dat_aug_2.tsv")
clean_data

```

## **Create a PCA object**

First, we run PCA and store the result in a variable called `pca_data`. To use the `prcomp()` function, we need to remove all non-numeric columns from the data. We can do this with the `where(is.numeric)`.

Second, we standardize the numeric variables (gene expression values) before performing PCA to make their scales comparable. We do this by setting the argument `scale = TRUE` inside `prcomp()`.

**Plotting the data in PC coordinates.** To do this, we combine the PCA results (the PC coordinates) with the original dataset. This allows us to group the samples by categorical variables that were removed before performing PCA. We can do this using the `augment()` function from **broom**. The new columns containing the PCA coordinates are named `.fittedPC1`, `.fittedPC2`, and so on.

```{r}
pca_fit <- clean_data |> 
  select_if(is.numeric) |> # retain only numeric columns as prcomp() can only work on numeric data
  prcomp(scale = TRUE) # do PCA on scaled data (which has zero mean and unit variance for every variable i.e. every variable contributes equally to the PCA) 

```

```{r}
PC_plot <- pca_fit |>
  augment(clean_data) |> 
  mutate(
    condition_tissue = paste(condition, tissue, sep = "-"),
    time_num = as.numeric(sub("h", "", timepoint)),
    # converts "0h" â†’ "0", get numeric values for better visualization
    timepoint = factor(
      time_num,
      levels = sort(unique(time_num)) # convert to ordered factor
    )
  )
  
PCA_plot <- ggplot(PC_plot, aes(.fittedPC1, .fittedPC2, color = timepoint, shape = condition_tissue)) +
  geom_point(size = 2) +
  labs(title = "PC coordinates plot", 
       subtitle = "PCA of gene expression across \nTissue, Condition, and Timepoint", 
         x = "Fitted PC1", y = "Fitted PC2", 
         color = "Timepoint") +
  theme_minimal()

ggsave("../results/05_key_plot_4.png", PCA_plot, width = 8, height = 5, dpi = 300)
```

**Very strong separation by tissue** along PC1 and **strong separation by condition + timepoint** along PC2.

The largest source of gene expression variation is tissue type.

**PC2 reflects the cold response trajectory over time.** Early cold response is closer to control. Later timepoints diverge strongly in gene expression.

## Variance explained by each PC (up to PC10)

In this plot we are looking at the variance explained by each principle component (up to PC10).

```{r}
pca_fit |>
  tidy(matrix = "eigenvalues")
```

```{r}
# get tibble of PCs and variances
PC_variance <- pca_fit |>
  tidy(matrix = "eigenvalues") |>
# choose only the first 10 PCs 
  filter(PC <= 10)
  
PC_variance_plot <- ggplot(PC_variance, aes(x = PC, y = percent)) + 
  geom_col(fill= "pink", alpha = 0.7) +
  scale_x_continuous(breaks = 1:10) +
  scale_y_continuous(labels = scales::percent,
                     expand = expansion(mult = c(0, 0.05))) +
  theme(plot.title = element_text(size = 10)) + 
  labs(title = "Variation of the First 10 Principal Components",
    x = "Principal components", 
    y = 'Percent') +
  theme_half_open(12) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(color = "gray50", linewidth = 0.2))

ggsave("../results/05_key_plot_5.png", PC_variance_plot, width = 8, height = 5, dpi = 300)
```

The first component captures more than 50 percent of the variation in the data. The remaining nine components, among the first ten, capture progressively smaller percentages of the variation.
