---
title: "Group08 - 05_analysis_3"
subtitle: "lm() via broom"
author: "Dana"
format: html
editor: visual
---

## Load packages

```{r}
library("tidyverse")
library("purrr")
library("broom")
```

## Load data

```{r}
data <- read_csv("_processed/expression_with_metadata.csv")
```

```{r}
data$timepoint <- factor(
  data$timepoint,
  levels = c("0h", "0.25h", "0.5h", "1.0h",
             "3.0h", "4.0h", "6.0h", 
             "12.0h", "24.0h")
)

data$condition <- factor(
  data$condition,
  levels = c("control", "cold")
)

data$tissue <- factor(
  data$tissue,
  levels = c("Shoots", "Roots")
)
```

## Small test - applying linear model to one gene

```{r}
gene = 'ORF25'

small_test_ORF25 <- data |> 
  dplyr::select(condition, tissue, timepoint, ORF25, replicate)
small_test_ORF25

small_test_ORF25_shoots <- small_test_ORF25 |>
  filter(tissue == 'Shoots')
small_test_ORF25_shoots

small_test_ORF25_shoots_control <- small_test_ORF25_shoots |>
  filter(condition == "control")
small_test_ORF25_shoots_control

small_test_ORF25_shoots_cold <- small_test_ORF25_shoots |>
  filter(condition == "cold")
small_test_ORF25_shoots_cold
```

```{r}
ggplot(small_test_ORF25_shoots, aes(y = ORF25, x = timepoint, color = condition)) +
  geom_point()
```

```{r}
# lm model for control shoots data only
model_lm <- small_test_ORF25_shoots_control |>
  group_by(condition, tissue, timepoint) |>
  lm(formula = ORF25 ~ timepoint,
     data = _)
print("lm() output:")
model_lm |>
  pluck("coefficients")


print("summary() output:")
model_lm |>
  summary()

```

Since P-value is \<2e-16, there is a statistically significant difference in ORF25 expression between 0 hrs and all the rest timepoints for control shoots. 0.25 hrs and 24 hrs data is not statistically significantly different from 0 hrs, which biologically makes sense since those are nearly the same times in the day. Gene expression decreases until 6 hrs and then goes up again.

```{r}
# lm for ORF25 expression explained by condition, tissue type and timepoint
model_ORF25 <- data |>
  group_by(condition, tissue, timepoint) |>
  lm(ORF25 ~ condition * tissue * timepoint, data = _)
print("lm() output:")
model_ORF25 |>
  pluck("coefficients")


print("summary() output:")
model_ORF25 |>
  summary()
```

At intercept, i.e. control, shoots at 0 hrs, ORF25 expression is statistically significantly different from 0.

cold

tissue

two way

three way

Some parts of the 3-way interaction cannot be estimated; the model is over-parameterised. Only main effects are seen

## Create long dataframe

```{r}
data_long <- data |>
  pivot_longer(cols = data[7:10561],
               names_to = "gene",
               values_to = "log2_expr_level")
data_long
```

## Create nested dataframe

```{r}
nested_data <- data_long |>
  group_by(gene) |>
  nest() |> 
  ungroup()
nested_data

```

```{r}
# check
nested_data |>
  filter(gene == "244901_at") |> 
  pull(data)
```

## Apply model_object to nested data

```{r}
# can take a few mins to run
nested_data <- nested_data |> 
  group_by(gene) |> 
  mutate(model_object = map(.x = data,
                   .f = ~lm(formula = log2_expr_level ~ condition,
                            data = .x)))
nested_data
```

```{r}
# check
nested_data |> 
  filter(gene == "244901_at") |> 
  pull(model_object)
```

```{r}
# tidy using broom
nested_data <- nested_data |> 
  mutate(model_object_tidy = map(.x = model_object,
                                 .f = ~tidy(x = .x,
                                            conf.int = TRUE,
                                            conf.level = 0.95)))

nested_data
```

```{r}
# check
nested_data |> 
  filter(gene == "244901_at") |> 
  pull(model_object_tidy)
```

```{r}
# unpack the nested models
data_estimates <- nested_data |>
  unnest(model_object_tidy) |> 
  filter(term == "conditionstress") |> 
  select(gene, p.value, estimate, conf.low, conf.high) |> 
  ungroup()
data_estimates
```

```{r}
# add q value
data_estimates <- data_estimates |>
  mutate(q.value = p.adjust(p.value),
         is_significant = case_when(q.value <= 0.05 ~ "yes",
                                    q.value > 0.05 ~ "no"))
data_estimates
```

## Select statistically significant genes

```{r}
data_estimates |>
  filter(is_significant == "yes") |> 
  select(gene, p.value, q.value)
```

## Forest plot

```{r}
forest_plot_364 <- data_estimates |> 
  filter(is_significant == "yes") |> 
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 1)) +
  labs(x = "Estimates (95% CIs)",
       y = "",
       title = "Statistically significant gene expression estimates across normal and stressed condtions")
forest_plot_364
```

Too many genes!

```{r}
# instead of plotting q value <0.05, check 0.01:
forest_plot_q_value <- data_estimates |>
  filter(q.value < 0.01 & is_significant == "yes") |> 
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 1)) +
  labs(x = "Estimates (95% CIs)",
       y = "",
       title = "Statistically significant gene expression estimates across normal and stressed condtions")
forest_plot_q_value
```

Still too big, there are 230 rows!

```{r}
# choose top 20 by absolute effect size
topN <- 20

forest_plot_top20 <- data_estimates |>
  filter(is_significant == "yes") |>
  slice_max(order_by = abs(estimate), n = topN) |>
  ggplot(aes(
    x = estimate,
    y = fct_reorder(gene, estimate),
    xmin = conf.low,
    xmax = conf.high
  )) +
  geom_vline(xintercept = 0) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  theme_minimal(base_size = 16) +
  labs(
    x = "Estimates (95% CIs)",
    y = "",
    title = paste0("Top ", topN, " genes (significant)")
  )

forest_plot_top20

```

The strongest significant genes are all upregulated in the stress condition.
