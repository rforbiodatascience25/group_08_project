---
title: "Group08 - 05_analysis_3"
subtitle: "lm() via broom"
author: "Dana"
format: html
editor: visual
---

## Load packages

```{r}
library("tidyverse")
library("purrr")
library("broom")
```

## Load data

```{r}
data <- read_tsv("../_raw/data/expression_with_metadata.tsv")
expr_annotated <- readr::read_tsv("../_raw/data/expression_annotated.tsv")
```

## Prepare the data

```{r}
# set to factors and set levels in the preferred order
data$gene <- as.factor(data$gene)
data$condition <- factor(data$condition,
                         levels = c("control", "cold"))
data$tissue <- factor(data$tissue,
                      levels = c("Roots", "Shoots"))
data$timepoint <- factor(data$timepoint,
                            levels = c("0h", "0.25h", "0.5h", "1.0h", "3.0h", 
                                       "4.0h","6.0h", "12.0h", "24.0h"))
data$replicate <- as.factor(data$replicate)

# remove h in timepoints and convert to numeric
small_test_ATSRC2$time <- as.numeric(sub("h", "", small_test_ATSRC2$timepoint))

```

## Small test - applying linear model to one gene (e.g. (AT)SRC2)

### Get the data for (AT)SRC2 only

```{r}
small_test_ATSRC2 <- data |>  
  filter(gene == "(AT)SRC2")
small_test_ATSRC2
```

### Plot ATSRC2 

```{r}
ggplot(small_test_ATSRC2, aes(x = time,
                         y = expression,
                         color = condition)) +
  geom_point() + 
  geom_line(aes(y = average)) +
  facet_wrap(~tissue) +
  ggtitle("Average log10 expression of (AT)SRC2 between both conditions, in both tissues") +
  ylab("Log10 expression")
```

```{r}
# lm for ATSRC2 expression explained by condition, tissue type and timepoint
model_ATSRC2 <- small_test_ATSRC2 |>
  group_by(condition, tissue, timepoint) |>
  lm(expression ~ condition * tissue * timepoint, data = _)
print("lm() output:")
model_ATSRC2 |>
  pluck("coefficients")


print("summary() output:")
model_ATSRC2 |>
  summary()
```

At intercept, i.e. control, roots at 0 hrs, (AT)SRC2 expression is statistically significantly different from 0. However, this is not biologically meaningful as gene expression is expected.

There are missing values for the cold condition at timepoints 0 and 0.25 hrs for both roots and shoots. This affects the model and makes it unbalanced and thus some effects are confounded.

Control and cold gene expression is statistically significant (p\<0.05), as is root vs shoot tissue gene expression (p\<0.05). However, not all timepoints are statistically significantly different. This is for one-way interactions and thus the effects for tissues, timepoints and conditions are pooled.

The three-way interactions give best biologically significant results since each condition is taken into account. However, as some data is missing, some interactions cannot be estimated (hence NA). Only two sets of interactions have p\<0.05 and thus gene expression is statistically significantly different. These are control vs cold & root vs shoot at timepoint 1 hr vs 0 hrs. However, this highlights that ANOVA is not suitable for this data. Need to test a time-series model, in order to test whether cold vs control alters the *shape* of the time curve, within each tissue (root / shoot).

## Trying polynomial time model for (AT)SRC2 

```{r}
model <- lm(expression ~ condition * poly(time, 3) * tissue, data = small_test_ATSRC2)
summary(model)

```

```{r}
small_test_ATSRC2$fitted <- predict(model)

plot4 <- ggplot(small_test_ATSRC2, 
                aes(x = time, y = expression, color = condition)) +geom_point() +
  geom_line(aes(y = fitted)) +
  facet_wrap(~ tissue)

plot4

```

## Applying linear model to all genes via nested application of lm() - TBC

## Create long dataframe

```{r}
data_long <- data |>
  pivot_longer(cols = data[7:10561],
               names_to = "gene",
               values_to = "log2_expr_level")
data_long
```

## Create nested dataframe

```{r}
nested_data <- data_long |>
  group_by(gene) |>
  nest() |> 
  ungroup()
nested_data

```

```{r}
# check
nested_data |>
  filter(gene == "244901_at") |> 
  pull(data)
```

## Apply model_object to nested data

```{r}
# can take a few mins to run
nested_data <- nested_data |> 
  group_by(gene) |> 
  mutate(model_object = map(.x = data,
                   .f = ~lm(formula = log2_expr_level ~ condition,
                            data = .x)))
nested_data
```

```{r}
# check
nested_data |> 
  filter(gene == "244901_at") |> 
  pull(model_object)
```

```{r}
# tidy using broom
nested_data <- nested_data |> 
  mutate(model_object_tidy = map(.x = model_object,
                                 .f = ~tidy(x = .x,
                                            conf.int = TRUE,
                                            conf.level = 0.95)))

nested_data
```

```{r}
# check
nested_data |> 
  filter(gene == "244901_at") |> 
  pull(model_object_tidy)
```

```{r}
# unpack the nested models
data_estimates <- nested_data |>
  unnest(model_object_tidy) |> 
  filter(term == "conditionstress") |> 
  select(gene, p.value, estimate, conf.low, conf.high) |> 
  ungroup()
data_estimates
```

```{r}
# add q value
data_estimates <- data_estimates |>
  mutate(q.value = p.adjust(p.value),
         is_significant = case_when(q.value <= 0.05 ~ "yes",
                                    q.value > 0.05 ~ "no"))
data_estimates
```

## Select statistically significant genes

```{r}
data_estimates |>
  filter(is_significant == "yes") |> 
  select(gene, p.value, q.value)
```

## Forest plot

```{r}
forest_plot_364 <- data_estimates |> 
  filter(is_significant == "yes") |> 
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 1)) +
  labs(x = "Estimates (95% CIs)",
       y = "",
       title = "Statistically significant gene expression estimates across normal and stressed condtions")
forest_plot_364
```

Too many genes!

```{r}
# instead of plotting q value <0.05, check 0.01:
forest_plot_q_value <- data_estimates |>
  filter(q.value < 0.01 & is_significant == "yes") |> 
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 1)) +
  labs(x = "Estimates (95% CIs)",
       y = "",
       title = "Statistically significant gene expression estimates across normal and stressed condtions")
forest_plot_q_value
```

Still too big, there are 230 rows!

```{r}
# choose top 20 by absolute effect size
topN <- 20

forest_plot_top20 <- data_estimates |>
  filter(is_significant == "yes") |>
  slice_max(order_by = abs(estimate), n = topN) |>
  ggplot(aes(
    x = estimate,
    y = fct_reorder(gene, estimate),
    xmin = conf.low,
    xmax = conf.high
  )) +
  geom_vline(xintercept = 0) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  theme_minimal(base_size = 16) +
  labs(
    x = "Estimates (95% CIs)",
    y = "",
    title = paste0("Top ", topN, " genes (significant)")
  )

forest_plot_top20

```

The strongest significant genes are all upregulated in the stress condition.
